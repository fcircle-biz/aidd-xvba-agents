# 全体方針

* データは\*\*Excelテーブル（ListObject）\*\*で管理。VBAは基本的にテーブルAPIで読み書き。
* すべてのレコードは**IDで一意管理**（文字列型）。連番はVBAで採番。
* 入力は**ユーザーフォーム**中心（手入力ミスを減らす）。シートは原則保護。
* ビジネスロジックは**モジュール分割**（UIと業務処理を分離）。
* 監査性確保（変更履歴・監査ログ）。期限超過アラートを起動時に通知。

---

# シート構成

1. ## メニュー（UI）

* 役割：操作起点。ボタン配置（「貸出」「返却」「備品登録」「利用者登録」「検索」「マスタ編集」「レポート」）
* 主要セル：

  * B2：本日（=TODAY()）
  * B4：総備品数、B5：貸出中点数、B6：延滞件数（後述のピボット/関数で集計）
* 外観：説明文、運用ルール、問い合わせ先

2. ## 台帳（Ledger）※テーブル名 `tblLedger`

* 役割：**貸出・返却の履歴**を全件保存（追記型）
* 列（推奨）

  * A: 取引ID（例 `TRX-2025-000123`）\[キー]
  * B: 備品ID（= `tblItem.ItemID`）
  * C: 利用者ID（= `tblUser.UserID`）
  * D: 貸出日時（数値日付）
  * E: 予定返却日（数値日付）
  * F: 返却日時（空可）
  * G: 数量（既定1）
  * H: 状態（"貸出","返却","取消"）
  * I: 担当者（貸出処理者）
  * J: 備考
  * K: タイムスタンプ（自動）
  * L: バージョン（整数、監査用）
* ルール：返却は**新規行でなく同一取引IDのF列更新**（状態は"返却"へ）

3. ## 備品マスタ（Items）※テーブル名 `tblItem`

* 列

  * A: ItemID（例 `ITM-000123`）\[キー]
  * B: 品目名
  * C: 区分（PC/周辺機器/工具/消耗品…）
  * D: 管理番号（資産番号・社内タグ・バーコード値）
  * E: 型番
  * F: メーカー
  * G: シリアル（任意）
  * H: 標準貸出日数（既定7）
  * I: 在庫総数（数量物の場合）
  * J: 貸出可否（TRUE/FALSE）
  * K: 保管場所
  * L: 備考
  * M: 登録日
  * N: 廃止フラグ（TRUE/FALSE）

4. ## 利用者マスタ（Users）※テーブル名 `tblUser`

* 列

  * A: UserID（例 `USR-000456`）\[キー]
  * B: 氏名
  * C: 部署
  * D: 連絡先メール
  * E: 内線/電話
  * F: ステータス（"有効","停止"）
  * G: 備考

5. ## 現況ビュー（Current）※テーブル名 `tblCurrent`（計算ビュー）

* 役割：**現時点の貸出状況**を算出（クエリビュー相当）
* 列（例）

  * A: ItemID
  * B: 品目名（VLOOKUP/XLOOKUPで`tblItem`参照）
  * C: 貸出中数量（= SUMIFS(tblLedger\[数量], ItemID一致, 状態="貸出") − SUMIFS(...状態="返却")）
  * D: 在庫総数（`tblItem`参照）
  * E: 貸出可能数（= D − C）
  * F: 延滞件数（後述式）
* 作成方法：数式 or Power Query どちらでも。最初は数式でOK。

6. ## 設定（Settings）※テーブル名 `tblSetting`

* 例：

  * キー/値：採番プレフィックス（TRX-, ITM-, USR-）、連番カウンタ、延滞閾値（0日）、管理者メール、フォーム初期値など

7. ## 監査ログ（Audit）※テーブル名 `tblAudit`

* 列：日時、ユーザー（Application.UserName）、操作（"貸出"等）、対象ID、詳細JSON風テキスト

8. ## レポート（Reports）

* ピボット：部署別貸出数、品目別回転率、延滞一覧など（印刷用テンプレ付）

---

# データ整合ルール

* **貸出可能条件**：`tblItem.貸出可否=TRUE` かつ `貸出可能数 >= 数量`
* **利用者**：`tblUser.ステータス="有効"`
* **延滞**：`返却日時 = 空 AND TODAY() > 予定返却日`
* **数量物**と\*\*個体物（シリアル管理）\*\*は同じ枠組みで、数量=1の連続貸出で表現可能（必要なら「個体ID」列をLedgerに追加）

---

# ユーザーフォーム設計

1. ## frmLend（貸出フォーム）

* 入力：備品ID（または検索ボタン）、利用者ID、数量、予定返却日（初期値＝今日＋標準貸出日数）、備考
* 検証：全必須、貸出可能数チェック、利用者有効チェック
* 実行：`modBiz.Lend()`呼び出し、Ledger追記、Audit追記、在庫ビュー更新

2. ## frmReturn（返却フォーム）

* 入力：取引ID or バーコード/検索で対象抽出、返却日時（既定=Now）
* 検証：未返却であること
* 実行：Ledgerの該当行F列更新、状態="返却"、Audit追記

3. ## frmItem（備品登録/更新）

* 入力：品目名、区分、在庫数、貸出可否…
* 実行：新規時は`modDb.NewItemId()`採番→`tblItem`へ

4. ## frmUser（利用者登録/更新）

* 入力：氏名、部署、連絡先
* 実行：`modDb.NewUserId()`採番→`tblUser`へ

5. ## frmSearch（検索）

* 条件：ItemID/名前/区分/利用者/未返却/延滞/期間など
* 結果：一覧→選択→詳細を別フォームで表示

---

# VBAモジュール構成（命名例）

* `modDb`: テーブル参照・採番・行追加/更新の**データ層**
* `modBiz`: 貸出・返却・延滞チェック等の**業務ロジック**
* `modUi`: メニューのボタンイベント・フォーム起動等の**UI層**
* `modUtil`: 共通（日付、ログ、エラーハンドリング、バリデーション）
* `ThisWorkbook`/`Workbook_Open`: 起動時フック（延滞通知、保護設定、名前定義など）

---

# 主要VBA仕様（抜粋コード方針）

> 実装時は**テーブル名/列名の誤字**が最頻バグなので、定数化して参照してください。

### 定数例（modDb）

```vb
' テーブル名・列名
Public Const T_LEDGER As String = "tblLedger"
Public Const T_ITEM As String   = "tblItem"
Public Const T_USER As String   = "tblUser"
Public Const T_AUDIT As String  = "tblAudit"

' 状態
Public Const ST_LEND As String = "貸出"
Public Const ST_RETURN As String = "返却"
```

### 採番（例：TRX/ITM/USR 共通化）

```vb
Public Function NewId(prefix As String) As String
    ' Settingsに保持する連番を読み、ゼロパディングして返す
    ' 例: TRX-2025-000123
End Function
```

### 貸出処理（modBiz.Lend）

```vb
Public Function Lend(itemId As String, userId As String, qty As Long, dueDate As Date, note As String) As Boolean
    ' 1) バリデーション：存在/有効性/在庫
    ' 2) 取引ID採番
    ' 3) Ledgerに行追加（状態=貸出、返却日時は空）
    ' 4) 監査ログ追加
    ' 5) 画面更新
End Function
```

### 返却処理（modBiz.ReturnByTrx）

```vb
Public Function ReturnByTrx(trxId As String, returnAt As Date) As Boolean
    ' Ledgerで該当取引IDの未返却行を検索→返却日時・状態更新
    ' 監査ログ追記
End Function
```

### 延滞チェック（起動時）

```vb
Private Sub Workbook_Open()
    ' 未返却 AND TODAY()>予定返却日 を抽出して件数表示（MsgBox or メニューセルに表示）
End Sub
```

### エラーハンドリング方針

* すべての公開関数の先頭/末尾にトラップを置き、`modUtil.LogError`で`tblAudit`に記録。
* フォーム上はユーザーに**日本語で簡潔な原因と対処**を表示。

---

# データ検証・入力規則

* `tblItem.貸出可否`：データ検証（TRUE/FALSE）
* `tblUser.ステータス`：リスト（有効/停止）
* 日付列：シリアル日付のみ（文字列禁止）
* `数量`：1以上の整数。個体管理時は既定1固定でも可。
* `予定返却日`：`貸出日時 <= 予定返却日`

---

# 便利式（数式例）

* **貸出中数量（アイテム別）**
  `=SUMIFS(tblLedger[数量], tblLedger[備品ID], [@ItemID], tblLedger[状態], "貸出") - SUMIFS(tblLedger[数量], tblLedger[備品ID], [@ItemID], tblLedger[状態], "返却")`
* **延滞フラグ（Ledger行）**
  `=IF(AND([@返却日時]="", TODAY()>[@予定返却日]), TRUE, FALSE)`

---

# セキュリティ/運用

* シートは**選択セルのみ解除**、他は保護（パスワードは設定シートに書かない）
* VBAプロジェクトにパスワード（閲覧防止）
* 週次バックアップ（ブック保存時イベントで日付付きコピー）
* 監査ログは追記専用（削除/改ざん不可の運用ルール）

---

# レポート例（最小3本）

1. 延滞一覧：取引ID／備品／利用者／予定返却日／経過日数
2. 部署別貸出数（期間フィルタ）
3. アイテム回転率＝（期間貸出回数 ÷ 在庫総数）

---

# 拡張オプション（任意）

* **バーコード運用**：`管理番号`や`取引ID`をバーコード化。フォームのテキストボックスにスキャンで入力→即Enter送信。
* **メール通知**：延滞n日前/当日/超過時にOutlook自動送信。
* **個体管理モード**：Ledgerに「個体ID」列を追加（PCやカメラ向け）。
* **承認フロー**：高額品のみ承認者IDが必須。
* **予約機能**：予定貸出の事前登録→当日引当。

---

# 受け入れ基準（完成定義）

* メニューから**貸出/返却/新規登録/検索**が一通り成功する
* 在庫・延滞が**メニューと現況ビュー**に正しく反映
* 異常系（在庫不足、利用者停止、日付不正）で**エラーメッセージ**表示
* 監査ログに**全操作記録**が残る
